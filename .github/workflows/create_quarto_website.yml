# The following builds on:
# https://medium.com/@delucmat/how-to-publish-bookdown-projects-with-github-actions-on-github-pages-6e6aecc7331e
# https://quarto.org/docs/publishing/github-pages.html#executing-code

name: create_website

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Step 1: check if any of the dependencies did change and update the 
  # Docker image
  update-docker-image:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
         
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        
      - name: Update Docker with Dependencies
        run: |
          ls && docker build . --file .github/workflows/update_image/Dockerfile --tag ghcr.io/methods-berlin/rlernplattform_dep:latest
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
          docker push ghcr.io/methods-berlin/rlernplattform_dep:latest   
  
  # next: create website using docker
  bookdown:
    needs: update-docker-image
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/methods-berlin/rlernplattform_dep:latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      - name: install sudo
        run: apt-get update && apt-get install -y sudo
      - name: install gh and jq for quarto
        run: |
         type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
         curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
         && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
         && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
         && sudo apt update \
         && sudo apt install gh -y\
         && apt install jq -y         
      - name: Set up pandoc
        uses: r-lib/actions/setup-pandoc@v2
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
      - name: Install dependencies and create book
        run: |
          install.packages(c("quarto"))
        shell: Rscript {0}
      - name: Render and Publish
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
